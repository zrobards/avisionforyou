// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User model with role-based access
model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String?
  passwordHash  String?   // Optional for Google OAuth users
  role          UserRole  @default(USER)
  emailVerified DateTime?
  image         String?   // For Google OAuth profile picture
  
  // NextAuth relations
  accounts      Account[]
  sessions      Session[]
  
  // App relations
  blogPosts     BlogPost[]
  newsletters   Newsletter[]
  rsvps         RSVP[]
  donations     Donation[]
  profile       UserProfile?
  assessment    Assessment?
  mediaUploads  MediaItem[] @relation("MediaUploads")
  boardUpdates  BoardUpdate[]
  boardDocuments BoardDocument[]
  communityAnnouncements CommunityAnnouncement[]
  duiRegistrations DUIRegistration[]
  createdPolls  CommunityPoll[] @relation("PollCreator")
  pollVotes     CommunityPollVote[]
  campaigns     Campaign[] @relation("CampaignCreator")
  campaignNotes CampaignNote[] @relation("CampaignNoteAuthor")
  meetingMinutes MeetingMinutes[] @relation("MinutesUploader")
  notifications Notification[]
  auditLogs     AuditLog[]

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@map("users")
}

// NextAuth Account model
model Account {
  id                 String  @id @default(cuid())
  userId             String
  type               String
  provider           String
  providerAccountId  String
  refresh_token      String?  @db.Text
  access_token       String?  @db.Text
  expires_at         Int?
  token_type         String?
  scope              String?
  id_token           String?  @db.Text
  session_state      String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

// NextAuth Session model
model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

enum UserRole {
  USER
  ADMIN
  BOARD
  ALUMNI
}

model UserProfile {
  id            String    @id @default(cuid())
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId        String    @unique
  bio           String?
  phone         String?
  preferences   Json?
  avatarUrl     String?
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@map("user_profiles")
}

// Assessment model for recovery program matching
model Assessment {
  id                String   @id @default(cuid())
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId            String   @unique
  answers           Json
  recommendedProgram String
  completed         Boolean  @default(true)
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@map("assessments")
}

// Programs/Meetings
model Program {
  id                String   @id @default(cuid())
  name              String   @unique
  slug              String   @unique
  description       String   @db.Text
  longDescription   String?  @db.Text
  programType       String   // "IOP", "SHELTER", "SELF_HELP", "FOOD", "HOUSING"
  schedule          String?
  location          String?
  phone             String?
  email             String?
  capacity          Int?
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  sessions          ProgramSession[]
  
  @@index([programType])
  @@map("programs")
}

model ProgramSession {
  id                String   @id @default(cuid())
  program           Program  @relation(fields: [programId], references: [id], onDelete: Cascade)
  programId         String
  title             String
  description       String   @db.Text
  startDate         DateTime
  endDate           DateTime
  location          String?
  format            String   @default("IN_PERSON") // "IN_PERSON" or "ONLINE"
  link              String?  // For ONLINE meetings
  capacity          Int?
  
  createdAt         DateTime @default(now())
  
  rsvps             RSVP[]
  
  @@index([programId])
  @@index([startDate])
  @@map("program_sessions")
}

// RSVP model
model RSVP {
  id                String   @id @default(cuid())
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId            String
  session           ProgramSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  sessionId         String
  status            RSVPStatus @default(CONFIRMED)
  reminderSent      Boolean  @default(false)
  reminder24hSent   Boolean  @default(false)
  reminder1hSent    Boolean  @default(false)
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@unique([userId, sessionId])
  @@index([userId])
  @@index([sessionId])
  @@map("rsvps")
}

enum RSVPStatus {
  CONFIRMED
  CANCELLED
  NO_SHOW
}

// Blog Posts
model BlogPost {
  id                String           @id @default(cuid())
  title             String
  slug              String           @unique
  content           String           @db.Text
  excerpt           String?
  author            User             @relation(fields: [authorId], references: [id], onDelete: Cascade)
  authorId          String
  status            BlogPostStatus   @default(DRAFT)
  
  publishedAt       DateTime?
  readTimeMinutes   Int?
  views             Int              @default(0)
  likes             Int              @default(0)
  imageUrl          String?
  category          String?
  tags              String?          // JSON array
  
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt
  
  @@index([authorId])
  @@index([status])
  @@index([publishedAt])
  @@map("blog_posts")
}

enum BlogPostStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

// Donations
model Donation {
  id                String   @id @default(cuid())
  user              User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  userId            String?
  
  amount            Decimal  @db.Decimal(10,2)
  currency          String   @default("USD")
  frequency         DonationFrequency @default(ONE_TIME)
  status            DonationStatus @default(COMPLETED)
  
  email             String?
  name              String?
  comment           String?  @db.Text
  impactMessage     String?
  
  // Square payment tracking
  squarePaymentId   String?
  squareSubscriptionId String? // For recurring donations
  
  // Recurring donation tracking
  nextRenewalDate   DateTime? // When the next payment will be processed
  renewalSchedule   String    @default("anniversary") // "anniversary" (same day each month/year) or "calendar" (1st/15th)
  recurringStartDate DateTime? // When the recurring donation started
  cancelledAt       DateTime? // When the recurring donation was cancelled
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([userId])
  @@index([status])
  @@index([frequency])
  @@index([squareSubscriptionId])
  @@index([nextRenewalDate])
  @@index([squarePaymentId])
  @@map("donations")
}

enum DonationFrequency {
  ONE_TIME
  MONTHLY
  YEARLY
}

enum DonationStatus {
  PENDING
  COMPLETED
  FAILED
  CANCELLED
}

// Testimonials
model Testimonial {
  id                String   @id @default(cuid())
  name              String
  role              String
  story             String   @db.Text
  quote             String?  @db.Text
  imageUrl          String?
  displayOnHome     Boolean  @default(false)
  order             Int?
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  @@map("testimonials")
}

// Site Content (editable text/rich content)
model SiteContent {
  id                String   @id @default(cuid())
  key               String   @unique
  value             String   @db.Text
  type              String   // "text", "richtext", "json"
  
  updatedAt         DateTime @updatedAt
  
  @@map("site_content")
}

// Founders/Leadership
model Founder {
  id                String   @id @default(cuid())
  name              String
  title             String
  bio               String   @db.Text
  story             String   @db.Text
  imageUrl          String?
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  @@map("founders")
}

model Leadership {
  id                String   @id @default(cuid())
  name              String
  title             String
  bio               String   @db.Text
  
  role              String?
  imageUrl          String?
  email             String?
  phone             String?
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  @@map("leadership")
}

// Core Values
model CoreValue {
  id                String   @id @default(cuid())
  name              String   @unique
  description       String   @db.Text
  order             Int?
  
  createdAt         DateTime @default(now())
  
  @@map("core_values")
}


// Audit log for admin actions
model AuditLog {
  id                String   @id @default(cuid())
  action            String
  entity            String
  entityId          String
  userId            String
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  details           Json?
  
  createdAt         DateTime @default(now())

  @@map("audit_logs")
}

// NextAuth Verification Token
model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

// Admission Inquiry Model
model AdmissionInquiry {
  id                String   @id @default(cuid())
  name              String
  email             String
  phone             String
  program           String
  message           String?  @db.Text
  status            String   @default("pending") // "pending", "reviewed", "contacted", "enrolled"
  notes             String?  @db.Text
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([status])
  @@index([email])
  @@map("admission_inquiries")
}

// Newsletter Content Model
model Newsletter {
  id              String   @id @default(cuid())
  title           String
  slug            String   @unique
  content         String   @db.Text
  excerpt         String?  @db.Text
  status          String   @default("DRAFT") // DRAFT, PUBLISHED
  imageUrl        String?
  
  author          User     @relation(fields: [authorId], references: [id], onDelete: Cascade)
  authorId        String
  
  sentAt          DateTime?
  sentCount       Int      @default(0)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  publishedAt     DateTime?
  
  @@index([status])
  @@index([authorId])
  @@index([publishedAt])
  @@map("newsletters")
}

// Newsletter Subscriber Model
model NewsletterSubscriber {
  id            String   @id @default(cuid())
  email         String   @unique
  subscribed    Boolean  @default(true)
  subscribedAt  DateTime @default(now())
  unsubscribedAt DateTime?
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([subscribed])
  @@map("newsletter_subscribers")
}

// Contact Inquiry Model
model ContactInquiry {
  id            String   @id @default(cuid())
  name          String
  email         String
  phone         String?
  department    String   // "general", "programs", "donate", "volunteer", "press", "careers"
  subject       String
  message       String   @db.Text
  status        ContactStatus @default(NEW)
  assignedTo    String?
  notes         String?  @db.Text
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([status])
  @@index([department])
  @@index([createdAt])
  @@map("contact_inquiries")
}

enum ContactStatus {
  NEW
  IN_PROGRESS
  RESPONDED
  RESOLVED
  ARCHIVED
}

// Team Member Model (for leadership page)
model TeamMember {
  id            String   @id @default(cuid())
  name          String
  title         String
  role          TeamRole @default(STAFF)
  bio           String   @db.Text
  credentials   String?  // e.g., "MBA, CPA", "MD, PhD"
  email         String?
  phone         String?
  linkedin      String?
  imageUrl      String?
  order         Int?
  isActive      Boolean  @default(true)
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([role])
  @@index([order])
  @@index([isActive])
  @@map("team_members")
}

enum TeamRole {
  BOARD_PRESIDENT
  BOARD_VP
  BOARD_TREASURER
  BOARD_SECRETARY
  BOARD_MEMBER
  EXECUTIVE_DIRECTOR
  STAFF
}

// Program Outcome Model (for impact tracking)
model ProgramOutcome {
  id            String   @id @default(cuid())
  programName   String   // "Surrender House", "MindBodySoul IOP", "Moving Mountains", "Overall"
  metric        String   // "completion_rate", "retention_90day", "housing_stability", "employment"
  value         Decimal  @db.Decimal(10,2) // The percentage or numeric value
  unit          String   @default("percent") // "percent", "count", "dollars"
  period        String   // "2024", "Q1 2024", "Last 12 months"
  description   String?  @db.Text
  isPublic      Boolean  @default(true)
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([programName])
  @@index([metric])
  @@index([isPublic])
  @@map("program_outcomes")
}

// Social Media Post Model for multi-platform management
model SocialMediaPost {
  id            String    @id @default(cuid())
  description   String    @db.Text
  videoUrl      String?   // URL to uploaded video
  platforms     String[]  // Array of platform IDs: facebook, instagram, twitter, youtube
  status        String    @default("draft") // draft, scheduled, posted, failed
  scheduledFor  DateTime? // When to post (if scheduled)
  postedAt      DateTime? // When it was actually posted
  
  // Platform-specific IDs (for tracking posts on each platform)
  facebookPostId   String?
  instagramPostId  String?
  twitterPostId    String?
  youtubeVideoId   String?
  
  // Engagement metrics
  likes         Int       @default(0)
  comments      Int       @default(0)
  shares        Int       @default(0)
  views         Int       @default(0)
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([status])
  @@index([scheduledFor])
  @@index([createdAt])
  @@map("social_media_posts")
}

// Media Library Model for storing photos/videos
model MediaItem {
  id            String    @id @default(cuid())
  filename      String
  type          String    // image, video
  url           String    @db.Text // URL or data URL
  size          Int       // File size in bytes
  mimeType      String    // e.g., image/jpeg, video/mp4
  tags          String[]  // event, recovery, donor, program, etc.
  usage         String[]  // website, social, grants, newsletter, marketing
  
  uploadedById  String
  uploadedBy    User      @relation("MediaUploads", fields: [uploadedById], references: [id], onDelete: Cascade)
  
  uploadedAt    DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([type])
  @@index([tags])
  @@index([uploadedById])
  @@index([uploadedAt])
  @@map("media_items")
}

// Webhook event logging for audit trail and debugging
model WebhookLog {
  id            String    @id @default(cuid())
  provider      String    // "square", "stripe", etc.
  eventType     String    // payment.completed, invoice.payment_pending, etc.
  eventId       String    // Unique event ID from provider
  donationId    String?   // Related donation if applicable
  data          Json      // Full webhook payload
  status        String    @default("processed") // processed, failed, pending
  errorMessage  String?   // If processing failed
  
  createdAt     DateTime  @default(now())
  processedAt   DateTime?

  @@index([provider])
  @@index([eventType])
  @@index([donationId])
  @@index([eventId])
  @@index([status])
  @@index([createdAt])
  @@map("webhook_logs")
}

// Social Media Stats for managing follower counts
model SocialStats {
  id            String    @id @default(cuid())
  platform      String    @unique // facebook, instagram, twitter, linkedin, tiktok
  followers     Int       @default(0)
  handle        String?   // @username
  url           String?   // Full URL to profile
  
  updatedAt     DateTime  @updatedAt
  createdAt     DateTime  @default(now())

  @@map("social_stats")
}

// Board Document Category Enum
enum BoardDocumentCategory {
  EXECUTIVE_DIRECTIVE
  BOARD_UPDATE
  FINANCIAL_SUMMARY
  GOVERNANCE
}

// Board Update Model
model BoardUpdate {
  id          String   @id @default(cuid())
  title       String
  content     String   @db.Text
  category    BoardDocumentCategory
  priority    Boolean  @default(false)  // High priority flag
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  authorId    String
  author      User     @relation(fields: [authorId], references: [id], onDelete: Cascade)

  @@index([category])
  @@index([priority])
  @@index([createdAt])
  @@map("board_updates")
}

// Board Document Model
model BoardDocument {
  id          String   @id @default(cuid())
  title       String
  description String?
  fileUrl     String
  fileName    String
  fileSize    Int?
  category    BoardDocumentCategory
  uploadedAt  DateTime @default(now())
  uploadedById String
  uploadedBy  User     @relation(fields: [uploadedById], references: [id], onDelete: Cascade)

  @@index([category])
  @@index([uploadedAt])
  @@map("board_documents")
}

// DUI Classes
model DUIClass {
  id            String   @id @default(cuid())
  title         String
  description   String?  @db.Text
  date          DateTime
  startTime     String   // e.g., "6:00 PM"
  endTime       String   // e.g., "9:00 PM"
  location      String
  price         Int      // in cents (e.g., 5000 = $50)
  capacity      Int
  instructor    String?
  active        Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  registrations DUIRegistration[]

  @@map("dui_classes")
}

model DUIRegistration {
  id              String   @id @default(cuid())
  
  // User info (may not be logged in)
  userId          String?
  user            User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  
  firstName       String
  lastName        String
  email           String
  phone           String?
  
  // Class reference
  classId         String
  class           DUIClass @relation(fields: [classId], references: [id], onDelete: Cascade)
  
  // Payment
  amount          Int
  paymentId       String?  // Square payment ID
  paymentStatus   PaymentStatus @default(PENDING)
  paymentUrl      String?  // Square checkout URL
  
  // Status
  status          RegistrationStatus @default(PENDING)
  attendedAt      DateTime?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([classId])
  @@index([userId])
  @@index([email])
  @@index([paymentStatus])
  @@index([status])
  @@index([paymentId])
  @@map("dui_registrations")
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

enum RegistrationStatus {
  PENDING
  CONFIRMED
  CANCELLED
  ATTENDED
  NO_SHOW
}

// Site Settings for configurable social media embeds
model SiteSettings {
  id                String  @id @default("settings")
  instagramUrl      String?
  facebookPageUrl   String?
  tiktokUsername    String?
  snapWidgetId      String?  // For Instagram widget
  updatedAt         DateTime @updatedAt
  
  @@map("site_settings")
}

// Community Announcements
model CommunityAnnouncement {
  id          String   @id @default(cuid())
  title       String
  content     String   @db.Text
  published   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  authorId    String
  author      User     @relation(fields: [authorId], references: [id], onDelete: Cascade)

  @@index([published])
  @@index([createdAt])
  @@map("community_announcements")
}

// Community Resources
model CommunityResource {
  id          String   @id @default(cuid())
  title       String
  description String?
  url         String
  category    String?  // e.g., "Recovery Resources", "Job Board", "Education"
  order       Int      @default(0)
  active      Boolean  @default(true)
  createdAt   DateTime @default(now())

  @@index([category])
  @@index([active])
  @@index([order])
  @@map("community_resources")
}

// Community Polls for Alumni Voting
model CommunityPoll {
  id          String   @id @default(cuid())
  title       String
  description String?  @db.Text
  active      Boolean  @default(true)
  closesAt    DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdById String
  createdBy   User     @relation("PollCreator", fields: [createdById], references: [id])
  votes       CommunityPollVote[]

  @@index([active])
  @@index([createdAt])
  @@index([createdById])
  @@map("community_polls")
}

model CommunityPollVote {
  id        String   @id @default(cuid())
  pollId    String
  poll      CommunityPoll @relation(fields: [pollId], references: [id], onDelete: Cascade)
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  vote      Boolean  // true = yes, false = no
  createdAt DateTime @default(now())
  
  @@unique([pollId, userId])
  @@index([pollId])
  @@index([userId])
  @@map("community_poll_votes")
}

// Campaign model for fundraising campaigns
model Campaign {
  id            String    @id @default(cuid())
  name          String
  slug          String    @unique
  description   String    @db.Text
  goalAmount    Decimal   @db.Decimal(10,2)
  raisedAmount  Decimal   @db.Decimal(10,2) @default(0)
  donorCount    Int       @default(0)
  status        CampaignStatus @default(DRAFT)
  startDate     DateTime
  endDate       DateTime
  targetAudience String?
  createdById   String
  createdBy     User      @relation("CampaignCreator", fields: [createdById], references: [id], onDelete: Cascade)
  notes         CampaignNote[]

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([status])
  @@index([slug])
  @@index([createdById])
  @@map("campaigns")
}

enum CampaignStatus {
  DRAFT
  ACTIVE
  COMPLETED
  CANCELLED
}

// Campaign notes/comments for board + admin discussion
model CampaignNote {
  id          String   @id @default(cuid())
  campaignId  String
  campaign    Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  authorId    String
  author      User     @relation("CampaignNoteAuthor", fields: [authorId], references: [id], onDelete: Cascade)
  content     String   @db.Text
  createdAt   DateTime @default(now())

  @@index([campaignId])
  @@map("campaign_notes")
}

// Meeting Minutes for board meetings
model MeetingMinutes {
  id          String   @id @default(cuid())
  title       String
  meetingDate DateTime
  fileUrl     String
  fileName    String
  attendees   String?  @db.Text
  uploadedById String
  uploadedBy  User     @relation("MinutesUploader", fields: [uploadedById], references: [id], onDelete: Cascade)
  createdAt   DateTime @default(now())

  @@index([meetingDate])
  @@index([uploadedById])
  @@map("meeting_minutes")
}

// Notifications for board and admin
model Notification {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  type      String   // "donation", "campaign", "user_registration", "document"
  title     String
  message   String
  link      String?
  read      Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([read])
  @@index([createdAt])
  @@map("notifications")
}

// Activity log for shared feed
model ActivityLog {
  id        String   @id @default(cuid())
  type      String   // "donation", "user_registered", "campaign_milestone", "document_uploaded", "meeting_rsvp"
  title     String
  detail    String?
  link      String?
  createdAt DateTime @default(now())

  @@index([type])
  @@index([createdAt])
  @@map("activity_logs")
}
