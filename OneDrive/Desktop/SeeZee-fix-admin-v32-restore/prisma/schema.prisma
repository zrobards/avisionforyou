generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Account {
  id                String  @id @default(cuid())
  type              String
  provider          String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  providerAccountId String  @map("provider_account_id")
  userId            String  @map("user_id")
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  expires      DateTime
  sessionToken String   @unique @map("session_token")
  userId       String   @map("user_id")
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model User {
  id                       String                   @id @default(cuid())
  email                    String                   @unique
  createdAt                DateTime                 @default(now())
  updatedAt                DateTime                 @updatedAt
  password                 String?
  image                    String?
  name                     String?
  emailVerified            DateTime?                @map("email_verified")
  role                     UserRole                 @default(CLIENT)
  company                  String?
  invitedById              String?
  phone                    String?
  profileDoneAt            DateTime?
  tosAcceptedAt            DateTime?
  tosVersion               String?
  twofaEnabled             Boolean                  @default(false)
  twofaSecret              String?
  questionnaireCompleted   DateTime?
  briefQuestionnaireId     String?                  @unique
  // New fields for enhanced auth & profile
  username                 String?                  @unique
  bio                      String?
  profileImageUrl          String?
  location                 String?
  timezone                 String?
  lastLogin                DateTime?
  emailVerificationToken   String?                  @unique
  emailVerificationExpires DateTime?
  // Existing relations
  accounts                 Account[]
  activities               Activity[]
  assignmentsCreated       Assignment[]             @relation("AssignmentCreatedBy")
  channelMemberships       ChannelMember[]
  messages                 ChatMessage[]
  completions              Completion[]             @relation("CompletionUser")
  notifications            Notification[]
  organizations            OrganizationMember[]
  projectRequests          ProjectRequest[]
  assignedProjects         Project[]                @relation("ProjectAssignee")
  resourcesCreated         Resource[]               @relation("ResourceCreatedBy")
  sessions                 Session[]
  signatures               Signature[]
  createdInviteCodes       StaffInviteCode[]        @relation("InviteCodeCreator")
  systemLogs               SystemLog[]
  assignedTodos            Todo[]                   @relation("TodoAssignee")
  createdTodos             Todo[]                   @relation("TodoCreator")
  trainingsCreated         Training[]               @relation("TrainingCreatedBy")
  briefQuestionnaire       BriefQuestionnaire?      @relation("UserBriefQuestionnaire")
  revenueSplitsCreated     RevenueSplit[]           @relation("RevenueSplitCreatedBy")
  clientTasksCreated       ClientTask[]             @relation("ClientTaskCreatedBy")
  leads                    Lead[]
  invitedBy                User?                    @relation("Inviter", fields: [invitedById], references: [id])
  invitees                 User[]                   @relation("Inviter")
  // New relations
  profile                  UserProfile?
  twoFactorAuth            TwoFactorAuth?
  userSessions             UserSession[]            @relation("UserSessions")
  notificationPreferences  NotificationPreferences?
  userPreferences          UserPreferences?
  tosAcceptances           TosAcceptance[]
  loginHistory             LoginHistory[]
  recordingsUploaded       Recording[]              @relation("RecordingsUploaded")

  @@map("users")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verificationtokens")
}

model Organization {
  id               String               @id @default(cuid())
  name             String
  slug             String               @unique
  website          String?
  createdAt        DateTime             @default(now())
  updatedAt        DateTime             @updatedAt
  address          String?
  billingEmail     String?
  city             String?
  country          String?              @default("US")
  email            String?
  phone            String?
  state            String?
  taxId            String?
  zipCode          String?
  stripeCustomerId String?
  invoices         Invoice[]
  leads            Lead[]
  members          OrganizationMember[]
  projects         Project[]

  // Enhanced organization fields
  industry            String?
  annualBudget        Int?
  leadSource          String?
  convertedFromLeadId String?

  // Relations
  maintenanceSubscriptions MaintenanceSubscription[]
  financeTransactions      FinanceTransaction[]
  calendarEvents           CalendarEvent[]

  @@map("organizations")
}

model OrganizationMember {
  id             String       @id @default(cuid())
  organizationId String
  userId         String
  role           OrgRole      @default(MEMBER)
  joinedAt       DateTime     @default(now())
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([organizationId, userId])
  @@map("organization_members")
}

model Lead {
  id             String           @id @default(cuid())
  name           String
  email          String
  message        String?
  createdAt      DateTime         @default(now())
  company        String?
  budget         String?
  phone          String?
  source         String?          @default("website")
  timeline       String?
  updatedAt      DateTime         @updatedAt
  convertedAt    DateTime?
  organizationId String?
  userId         String?
  requirements   Json?
  serviceType    ServiceCategory?
  status         LeadStatus       @default(NEW)
  metadata       Json?
  internalNotes  String?
  organization   Organization?    @relation(fields: [organizationId], references: [id])
  user           User?            @relation(fields: [userId], references: [id])
  project        Project?

  // Prospect/Client Finder fields
  ein                String? // Tax ID for nonprofits
  websiteUrl         String?
  address            String?
  city               String?
  state              String?
  zipCode            String?
  country            String          @default("US")
  latitude           Float?
  longitude          Float?
  category           String? // Arts, Education, Health, etc.
  subcategory        String?
  annualRevenue      Int? // Estimated annual revenue
  employeeCount      Int?
  leadScore          Int             @default(0) // 0-100
  hasWebsite         Boolean         @default(false)
  websiteQuality     WebsiteQuality?
  needsAssessment    Json? // { responsive: false, accessible: false, etc. }
  assignedToId       String?
  lastContactedAt    DateTime?
  emailsSent         Int             @default(0)
  lastEmailSentAt    DateTime?
  outreachCampaignId String?
  tags               String[]

  emailCampaigns EmailCampaign[] @relation("LeadCampaigns")
  prospect       Prospect?       @relation("ProspectToLead")

  @@index([status])
  @@index([leadScore])
  @@index([city, state])
  @@map("leads")
}

// Prospects are potential leads discovered through lead finder
// They become actual leads only when user clicks "Reach Out"
model Prospect {
  id        String   @id @default(cuid())
  name      String
  email     String   @default("") // May be empty from discovery
  phone     String?
  company   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Discovery source
  source            String @default("GOOGLE_PLACES")
  discoveryMetadata Json? // Store original discovery data

  // Address fields
  address   String?
  city      String?
  state     String?
  zipCode   String?
  country   String  @default("US")
  latitude  Float?
  longitude Float?

  // Business info
  ein           String?
  category      String?
  subcategory   String?
  annualRevenue Int?
  employeeCount Int?

  // Website info
  websiteUrl      String?
  hasWebsite      Boolean         @default(false)
  websiteQuality  WebsiteQuality?
  needsAssessment Json?

  // Scoring
  leadScore Int      @default(0)
  tags      String[]

  // AI Analysis
  aiAnalysis    Json? // Store AI analysis results
  internalNotes String?

  // Conversion tracking
  convertedToLeadId String?   @unique
  convertedToLead   Lead?     @relation("ProspectToLead", fields: [convertedToLeadId], references: [id])
  convertedAt       DateTime?

  @@index([leadScore])
  @@index([city, state])
  @@index([convertedAt])
  @@index([source])
  @@map("prospects")
}

model Project {
  id                   String                @id @default(cuid())
  name                 String
  description          String?
  status               ProjectStatus         @default(LEAD)
  isNonprofit          Boolean               @default(false)
  budget               Decimal?
  startDate            DateTime?
  endDate              DateTime?
  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @updatedAt
  assigneeId           String?
  leadId               String?               @unique
  organizationId       String
  questionnaireId      String?               @unique
  stripeCustomerId     String?
  stripeSubscriptionId String?
  maintenancePlan      String?
  maintenanceStatus    String?
  nextBillingDate      DateTime?
  githubRepo           String?
  vercelUrl            String?
  feedEvents           FeedEvent[]
  files                File[]
  invoices             Invoice[]
  maintenanceSchedules MaintenanceSchedule[]
  messageThreads       MessageThread[]
  milestones           ProjectMilestone[]
  clientTasks          ClientTask[]
  projectQuestionnaire ProjectQuestionnaire?
  revenueSplits        RevenueSplit[]
  maintenancePlanRel   MaintenancePlan?
  assignee             User?                 @relation("ProjectAssignee", fields: [assigneeId], references: [id])
  lead                 Lead?                 @relation(fields: [leadId], references: [id])
  organization         Organization          @relation(fields: [organizationId], references: [id])
  questionnaire        Questionnaire?        @relation(fields: [questionnaireId], references: [id])
  requests             Request[]
  subscriptions        Subscription[]
  changeRequests       ChangeRequest[]
  todos                Todo[]

  // Enhanced project tracking fields
  currentStage     ProjectStage @default(DISCOVERY)
  progress         Int          @default(0) // 0-100
  designFiles      String[] // URLs to Figma, etc.
  designApprovedAt DateTime?
  launchedAt       DateTime?
  liveUrl          String?

  // Vercel integration
  vercelProjectId String?
  vercelTeamId    String?
  // vercelUrl is defined above with githubRepo

  // Relations
  financeTransactions FinanceTransaction[]
  recordings          Recording[]
  calendarEvents      CalendarEvent[]

  @@map("projects")
}

model ProjectMilestone {
  id          String    @id @default(cuid())
  title       String
  description String?
  dueDate     DateTime?
  completed   Boolean   @default(false)
  completedAt DateTime?
  projectId   String
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  project     Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@map("project_milestones")
}

model Invoice {
  id                 String        @id @default(cuid())
  number             String        @unique
  status             InvoiceStatus @default(DRAFT)
  total              Decimal
  createdAt          DateTime      @default(now())
  updatedAt          DateTime      @updatedAt
  amount             Decimal
  currency           String        @default("USD")
  description        String?
  dueDate            DateTime
  organizationId     String
  paidAt             DateTime?
  projectId          String?
  sentAt             DateTime?
  stripeInvoiceId    String?
  tax                Decimal?      @default(0)
  title              String
  customerApprovedAt DateTime?
  adminApprovedAt    DateTime?
  invoiceType        String?       @default("deposit") // "deposit", "final", "subscription", "custom"
  isFirstInvoice     Boolean       @default(false) // Marks the first invoice that sets project price
  leadId             String?
  items              InvoiceItem[]
  organization       Organization  @relation(fields: [organizationId], references: [id])
  project            Project?      @relation(fields: [projectId], references: [id])
  payments           Payment[]

  @@map("invoices")
}

model InvoiceItem {
  id          String  @id @default(cuid())
  description String
  quantity    Int     @default(1)
  rate        Decimal
  amount      Decimal
  invoiceId   String
  invoice     Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@map("invoice_items")
}

model Payment {
  id              String        @id @default(cuid())
  amount          Decimal
  status          PaymentStatus @default(PENDING)
  method          String?
  createdAt       DateTime      @default(now())
  currency        String        @default("USD")
  invoiceId       String
  processedAt     DateTime?
  stripeChargeId  String?
  stripePaymentId String?
  invoice         Invoice       @relation(fields: [invoiceId], references: [id])

  @@map("payments")
}

model MaintenancePlan {
  id                      String                @id @default(cuid())
  projectId               String                @unique
  tier                    String // NonprofitTier value: ESSENTIALS, DIRECTOR, COO
  monthlyPrice            Decimal
  features                Json?
  billingDay              Int                   @default(1)
  status                  MaintenancePlanStatus @default(ACTIVE)
  stripeSubscriptionId    String?
  stripeCheckoutSessionId String?
  createdAt               DateTime              @default(now())
  updatedAt               DateTime              @updatedAt
  cancelledAt             DateTime?
  project                 Project               @relation(fields: [projectId], references: [id], onDelete: Cascade)

  // Subscription limits per tier
  subscriptionsIncluded Int @default(2) // Subscriptions included in base tier
  maxSubscriptions      Int @default(3) // Hard cap per tier

  // Hours tracking - support hours pool
  supportHoursIncluded Int   @default(8) // Monthly support hours included (doubled from 4)
  supportHoursUsed     Float @default(0) // Support hours used this period

  // Change request tracking - separate from support hours
  changeRequestsIncluded Int @default(3) // Change requests per month
  changeRequestsUsed     Int @default(0) // Requests used this period

  // Billing period
  currentPeriodStart DateTime?
  currentPeriodEnd   DateTime?

  // Rollover hours system
  rolloverEnabled Boolean @default(true)
  rolloverCap     Int     @default(16) // Max rollover hours (2x monthly, doubled from 8)
  rolloverHours   Float   @default(0) // Current banked rollover hours

  // On-demand billing settings
  onDemandEnabled       Boolean @default(false)
  hourlyOverageRate     Int     @default(7500) // $75.00 in cents
  dailyRequestLimit     Int     @default(3) // Max requests per day in on-demand mode
  dailySpendCap         Int     @default(50000) // $500 daily cap in cents
  monthlySpendCap       Int     @default(200000) // $2000 monthly cap in cents
  urgentRequestsPerWeek Int     @default(2) // Max urgent requests per week
  urgentRequestsUsed    Int     @default(0) // Urgent requests used this week

  // Daily tracking for on-demand
  requestsToday   Int       @default(0)
  lastRequestDate DateTime?

  // Grace period tracking
  gracePeriodUsed Boolean @default(false) // One-time 1hr grace used

  // Usage tracking
  logs                 MaintenanceLog[]
  hourPacks            HourPack[]
  rolloverRecords      RolloverHours[]
  overageNotifications OverageNotification[]

  @@map("maintenance_plans")
}

model PricingRule {
  id                 String    @id @default(cuid())
  name               String    @unique
  description        String?
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt
  active             Boolean   @default(true)
  basePrice          Decimal
  extendedMultiplier Decimal?  @default(0.9)
  features           Json?
  rushMultiplier     Decimal?  @default(1.5)
  serviceType        String
  standardMultiplier Decimal?  @default(1.0)
  validFrom          DateTime  @default(now())
  validTo            DateTime?
  quotes             Quote[]

  @@map("pricing_rules")
}

model Quote {
  id                 String      @id @default(cuid())
  serviceType        String
  timeline           String
  features           Json?
  requirements       Json?
  basePrice          Decimal
  featurePrice       Decimal     @default(0)
  timelineMultiplier Decimal     @default(1.0)
  subtotal           Decimal
  tax                Decimal     @default(0)
  total              Decimal
  customerName       String?
  customerEmail      String?
  pricingRuleId      String
  convertedToLead    Boolean     @default(false)
  convertedAt        DateTime?
  expiresAt          DateTime
  createdAt          DateTime    @default(now())
  pricingRule        PricingRule @relation(fields: [pricingRuleId], references: [id])

  @@map("quotes")
}

model File {
  id              String          @id @default(cuid())
  name            String
  size            Int
  url             String
  createdAt       DateTime        @default(now())
  mimeType        String
  originalName    String
  projectId       String?
  scanResult      String?
  type            FileType
  uploadedById    String?
  virusScanStatus VirusScanStatus @default(PENDING)
  project         Project?        @relation(fields: [projectId], references: [id])

  @@map("files")
}

model Signature {
  id            String   @id @default(cuid())
  signedAt      DateTime @default(now())
  documentId    String
  ipAddress     String?
  signatureData String
  signerEmail   String
  signerName    String
  userAgent     String?
  userId        String?
  user          User?    @relation(fields: [userId], references: [id])

  @@map("signatures")
}

model Notification {
  id        String           @id @default(cuid())
  type      NotificationType @default(INFO)
  title     String
  message   String
  createdAt DateTime         @default(now())
  read      Boolean          @default(false)
  userId    String
  projectId String?
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@map("notifications")
}

model WebhookEvent {
  id        String   @id @default(cuid())
  eventId   String   @unique
  type      String
  data      Json
  processed Boolean  @default(false)
  createdAt DateTime @default(now())

  @@map("webhook_events")
}

model Channel {
  id          String          @id @default(cuid())
  name        String
  description String?
  type        ChannelType     @default(GENERAL)
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  members     ChannelMember[]
  messages    ChatMessage[]

  @@map("channels")
}

model ChannelMember {
  id        String   @id @default(cuid())
  channelId String
  userId    String
  joinedAt  DateTime @default(now())
  channel   Channel  @relation(fields: [channelId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([channelId, userId])
  @@map("channel_members")
}

model ChatMessage {
  id        String   @id @default(cuid())
  content   String
  channelId String
  authorId  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  author    User     @relation(fields: [authorId], references: [id])
  channel   Channel  @relation(fields: [channelId], references: [id], onDelete: Cascade)

  @@map("chat_messages")
}

model Todo {
  id              String       @id @default(cuid())
  title           String
  description     String?
  status          TodoStatus   @default(TODO)
  priority        TodoPriority @default(MEDIUM)
  assignedToId    String?
  createdById     String
  projectId       String?
  changeRequestId String?      @unique // Link to change request if auto-generated
  dueDate         DateTime?
  completedAt     DateTime?
  submittedAt     DateTime?
  submissionNotes String?
  approvedAt      DateTime?
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  assignedTo      User?        @relation("TodoAssignee", fields: [assignedToId], references: [id])
  createdBy       User         @relation("TodoCreator", fields: [createdById], references: [id])
  project         Project?     @relation(fields: [projectId], references: [id])
  changeRequest   ChangeRequest? @relation(fields: [changeRequestId], references: [id])

  // Team/Role assignment fields
  assignedToRole  UserRole? // If assigned to a role group
  assignedToTeamId String? // If assigned to a team/organization

  // Kanban board fields
  column         String   @default("todo") // "todo", "in-progress", "review", "done"
  position       Int      @default(0) // for ordering within column
  estimatedHours Float?
  actualHours    Float?
  dependencies   String[] // Task IDs this task depends on
  attachments    String[] // File URLs

  // Time tracking
  timeLogs TimeLog[]

  @@index([projectId, column])
  @@index([status])
  @@index([changeRequestId])
  @@index([assignedToRole])
  @@index([assignedToTeamId])
  @@map("todos")
}

model SystemLog {
  id         String   @id @default(cuid())
  action     String
  entityType String
  entityId   String
  userId     String
  metadata   Json?
  createdAt  DateTime @default(now())
  area       String?
  message    String?
  meta       Json?
  refId      String?
  user       User     @relation(fields: [userId], references: [id])

  @@index([entityType, entityId])
  @@index([userId])
  @@index([createdAt])
  @@index([area, refId])
  @@map("system_logs")
}

model StaffInviteCode {
  id          String    @id @default(cuid())
  email       String
  role        UserRole
  codeHash    String
  createdById String
  expiresAt   DateTime
  redeemedAt  DateTime?
  attempts    Int       @default(0)
  maxAttempts Int       @default(5)
  createdAt   DateTime  @default(now())
  createdBy   User      @relation("InviteCodeCreator", fields: [createdById], references: [id])

  @@index([email])
  @@map("staff_invite_codes")
}

model Message {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  content   String
  email     String
  name      String
  status    String   @default("UNREAD")
  subject   String?

  @@map("messages")
}

model Questionnaire {
  id        String   @id @default(cuid())
  userEmail String
  data      Json
  estimate  Int?
  deposit   Int?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  project   Project?

  @@map("questionnaires")
}

model Subscription {
  id                    String          @id @default(cuid())
  projectId             String
  stripeId              String          @unique
  priceId               String
  status                String
  currentPeriodEnd      DateTime?
  createdAt             DateTime        @default(now())
  updatedAt             DateTime        @updatedAt
  planName              String? // "Standard Monthly", "Premium Monthly", "Standard Annual", "Premium Annual"
  changeRequestsAllowed Int             @default(2) // Number of change requests allowed per period
  changeRequestsUsed    Int             @default(0) // Number of change requests used in current period
  resetDate             DateTime? // When change requests reset
  project               Project         @relation(fields: [projectId], references: [id], onDelete: Cascade)
  changeRequests        ChangeRequest[]

  // Addon subscription support
  isAddon         Boolean @default(false) // True if this is an addon beyond included
  additionalCost  Int     @default(0) // Additional monthly cost in cents
  additionalHours Int     @default(0) // Additional hours this addon provides

  @@map("subscriptions")
}

model Request {
  id        String        @id @default(cuid())
  projectId String
  title     String
  details   String
  state     String        @default("new")
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
  source    RequestSource @default(MANUAL)
  project   Project       @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@map("requests")
}

model ChangeRequest {
  id             String       @id @default(cuid())
  projectId      String
  subscriptionId String
  description    String
  status         String       @default("pending") // "pending", "approved", "in_progress", "completed", "rejected"
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  completedAt    DateTime?
  project        Project      @relation(fields: [projectId], references: [id], onDelete: Cascade)
  subscription   Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)
  task           Todo?        // Auto-generated task (one-to-one relation via Todo.changeRequestId)

  // Hours tracking
  estimatedHours Float? // Estimated time for this request
  actualHours    Float? // Actual hours spent
  hoursDeducted  Float? // Hours deducted from monthly/rollover/pack
  hoursSource    String? // "monthly", "rollover", "pack"
  hourPackId     String? // If deducted from hour pack

  // Categorization
  category   ChangeRequestCategory @default(OTHER)
  priority   ChangeRequestPriority @default(NORMAL)
  urgencyFee Int                   @default(0) // Fee in cents for urgent requests

  // Billing
  isOverage        Boolean @default(false) // Beyond included hours
  overageAmount    Int? // Overage billing amount in cents
  flaggedForReview Boolean @default(false) // Needs billing review

  // Client approval for large requests
  requiresClientApproval Boolean   @default(false) // For >2hr estimates
  clientApprovedAt       DateTime?

  // Attachments
  attachments String[] // URLs to attached files

  @@map("change_requests")
}

model ProjectRequest {
  id             String        @id @default(cuid())
  name           String?
  email          String?
  projectType    String?
  goal           String?
  timeline       String?
  createdAt      DateTime      @default(now())
  company        String?
  contactEmail   String        @default("")
  description    String        @default("")
  notes          String?
  resourcesUrl   String?
  services       ServiceType[]
  title          String        @default("")
  updatedAt      DateTime      @default(now()) @updatedAt
  userId         String?
  budget         BudgetTier    @default(UNKNOWN)
  status         RequestStatus @default(DRAFT)
  user           User?         @relation(fields: [userId], references: [id])
  
  // Hours tracking
  estimatedHours Float? // Estimated hours set by client when creating request
  actualHours    Float? // Actual hours set by admin when completing request
  hoursDeducted  Float? // Hours deducted from maintenance plan
  hoursSource    String? // "monthly", "rollover", "pack" - where hours were deducted from
  hourPackId     String? // If deducted from hour pack

  @@map("project_requests")
}

model Activity {
  id          String       @id @default(cuid())
  type        ActivityType
  title       String
  description String?
  metadata    Json?
  userId      String?
  entityType  String?
  entityId    String?
  read        Boolean      @default(false)
  readAt      DateTime?
  createdAt   DateTime     @default(now())
  projectId   String?
  createdBy   String? // User ID or "SYSTEM"
  user        User?        @relation(fields: [userId], references: [id])

  @@index([createdAt])
  @@index([userId])
  @@index([read])
  @@index([projectId, createdAt])
  @@map("activities")
}

model MaintenanceSchedule {
  id           String            @id @default(cuid())
  projectId    String
  title        String
  description  String?
  status       MaintenanceStatus @default(UPCOMING)
  scheduledFor DateTime
  completedAt  DateTime?
  assignedToId String?
  notes        String?
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt
  project      Project           @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([status])
  @@index([scheduledFor])
  @@map("maintenance_schedules")
}

model LearningResource {
  id           String   @id @default(cuid())
  title        String
  description  String?
  type         String
  url          String
  category     String?
  thumbnailUrl String?
  duration     Int?
  difficulty   String?
  tags         String[]
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([category])
  @@index([type])
  @@map("learning_resources")
}

model Tool {
  id          String   @id @default(cuid())
  name        String
  description String?
  url         String
  category    String
  logoUrl     String?
  pricing     String?
  tags        String[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([category])
  @@map("tools")
}

model Link {
  id          String       @id @default(cuid())
  title       String
  url         String
  description String?
  category    LinkCategory @default(OTHER)
  icon        String?
  color       String?
  order       Int          @default(0)
  pinned      Boolean      @default(false)
  createdById String?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  @@index([category])
  @@index([pinned])
  @@index([order])
  @@map("links")
}

model Automation {
  id          String    @id @default(cuid())
  name        String
  description String?
  trigger     String
  action      String
  config      Json
  enabled     Boolean   @default(true)
  lastRunAt   DateTime?
  runCount    Int       @default(0)
  createdById String
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([enabled])
  @@index([trigger])
  @@map("automations")
}

model Training {
  id          String       @id @default(cuid())
  title       String
  type        TrainingType
  description String
  visibility  Visibility   @default(INTERNAL)
  url         String?
  fileKey     String?
  tags        String[]
  createdById String
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  assignments Assignment[]
  createdBy   User         @relation("TrainingCreatedBy", fields: [createdById], references: [id], onDelete: Cascade)

  @@index([visibility])
  @@index([type])
  @@index([createdById])
  @@map("trainings")
}

model Resource {
  id          String     @id @default(cuid())
  title       String
  description String
  url         String
  visibility  Visibility @default(INTERNAL)
  tags        String[]
  createdById String
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  createdBy   User       @relation("ResourceCreatedBy", fields: [createdById], references: [id], onDelete: Cascade)

  @@index([visibility])
  @@index([createdById])
  @@map("resources")
}

model ToolEntry {
  id          String     @id @default(cuid())
  name        String
  category    String
  url         String
  description String
  ownerTeamId String?
  visibility  Visibility @default(INTERNAL)
  icon        String?
  tags        String[]
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  @@index([visibility])
  @@index([category])
  @@map("tool_entries")
}

model Assignment {
  id           String       @id @default(cuid())
  trainingId   String
  audienceType AudienceType
  userId       String?
  teamId       String?
  role         UserRole?
  dueAt        DateTime?
  createdById  String
  createdAt    DateTime     @default(now())
  createdBy    User         @relation("AssignmentCreatedBy", fields: [createdById], references: [id], onDelete: Cascade)
  training     Training     @relation(fields: [trainingId], references: [id], onDelete: Cascade)
  completions  Completion[]

  @@index([trainingId])
  @@index([audienceType])
  @@index([userId])
  @@index([teamId])
  @@index([role])
  @@index([dueAt])
  @@map("assignments")
}

model Completion {
  id           String           @id @default(cuid())
  assignmentId String
  userId       String
  status       CompletionStatus @default(NOT_STARTED)
  startedAt    DateTime?
  completedAt  DateTime?
  notes        String?
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt
  assignment   Assignment       @relation(fields: [assignmentId], references: [id], onDelete: Cascade)
  user         User             @relation("CompletionUser", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([assignmentId, userId])
  @@index([userId])
  @@index([status])
  @@map("completions")
}

model FeedEvent {
  id        String   @id @default(cuid())
  projectId String
  type      String
  payload   Json?
  createdAt DateTime @default(now())
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId, createdAt])
  @@map("feed_events")
}

model MessageThread {
  id        String          @id @default(cuid())
  projectId String?
  clientId  String
  subject   String
  status    String          @default("open")
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt
  project   Project?        @relation(fields: [projectId], references: [id], onDelete: Cascade)
  messages  ThreadMessage[]

  @@index([projectId])
  @@index([clientId])
  @@map("message_threads")
}

model ThreadMessage {
  id        String        @id @default(cuid())
  threadId  String
  senderId  String
  role      String
  content   String
  createdAt DateTime      @default(now())
  thread    MessageThread @relation(fields: [threadId], references: [id], onDelete: Cascade)

  @@index([threadId, createdAt])
  @@map("thread_messages")
}

model BriefQuestionnaire {
  id                 String   @id @default(cuid())
  userId             String   @unique
  companyName        String
  projectType        String
  budgetRange        String
  timelinePreference String
  keyFeatures        Json
  currentWebsite     String?
  notes              String?
  createdAt          DateTime @default(now())
  user               User     @relation("UserBriefQuestionnaire", fields: [userId], references: [id], onDelete: Cascade)

  @@map("brief_questionnaires")
}

model ClientTask {
  id                    String                 @id @default(cuid())
  projectId             String
  title                 String
  description           String
  type                  String
  status                String                 @default("pending")
  dueDate               DateTime?
  completedAt           DateTime?
  data                  Json?
  assignedToClient      Boolean                @default(true)
  requiresUpload        Boolean                @default(false)
  submissionNotes       String?
  createdById           String?
  createdAt             DateTime               @default(now())
  updatedAt             DateTime               @updatedAt
  project               Project                @relation(fields: [projectId], references: [id], onDelete: Cascade)
  createdBy             User?                  @relation("ClientTaskCreatedBy", fields: [createdById], references: [id])
  projectQuestionnaires ProjectQuestionnaire[]

  @@index([projectId])
  @@index([status])
  @@index([assignedToClient])
  @@map("client_tasks")
}

model ProjectQuestionnaire {
  id          String     @id @default(cuid())
  projectId   String     @unique
  taskId      String
  responses   Json
  completedAt DateTime?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  project     Project    @relation(fields: [projectId], references: [id], onDelete: Cascade)
  task        ClientTask @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@index([taskId])
  @@map("project_questionnaires")
}

model RevenueSplit {
  id            String   @id @default(cuid())
  projectId     String
  totalAmount   Decimal
  businessShare Decimal
  adminShares   Json
  notes         String?
  createdById   String
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  project       Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  createdBy     User     @relation("RevenueSplitCreatedBy", fields: [createdById], references: [id])

  @@index([projectId])
  @@index([createdById])
  @@map("revenue_splits")
}

model AISuggestion {
  id          String   @id @default(cuid())
  projectId   String
  type        String
  title       String
  description String
  confidence  Int // 0-100
  source      String
  status      String   @default("NEW") // NEW, ACCEPTED, DISMISSED
  metadata    Json?
  createdAt   DateTime @default(now())

  @@index([projectId, status])
  @@map("ai_suggestions")
}

enum UserRole {
  ADMIN
  STAFF
  CLIENT
  CEO
  CFO
  DESIGNER
  DEV
  OUTREACH
  INTERN
  PARTNER
  FRONTEND
  BACKEND
}

enum OrgRole {
  OWNER
  ADMIN
  MEMBER
}

enum LeadStatus {
  NEW
  CONTACTED
  QUALIFIED
  PROPOSAL_SENT
  CONVERTED
  LOST
}

enum RequestStatus {
  DRAFT
  SUBMITTED
  REVIEWING
  NEEDS_INFO
  APPROVED
  REJECTED
  ARCHIVED
}

enum RequestSource {
  MANUAL
  AI
}

enum BudgetTier {
  UNKNOWN
  MICRO
  SMALL
  MEDIUM
  LARGE
  ENTERPRISE
}

enum ServiceType {
  WEB_APP
  WEBSITE
  ECOMMERCE
  AI_DATA
  MOBILE
  BRANDING
  OTHER
}

enum ProjectStatus {
  LEAD
  QUOTED
  DEPOSIT_PAID
  ACTIVE
  REVIEW
  COMPLETED
  MAINTENANCE
  CANCELLED
}

enum InvoiceStatus {
  DRAFT
  SENT
  PAID
  OVERDUE
  CANCELLED
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

enum NotificationType {
  INFO
  SUCCESS
  WARNING
  ERROR
}

enum FileType {
  IMAGE
  DOCUMENT
  VIDEO
  OTHER
}

enum VirusScanStatus {
  PENDING
  CLEAN
  INFECTED
  ERROR
}

enum ChannelType {
  GENERAL
  PROJECT
  SUPPORT
  DEVELOPMENT
  CUSTOM
}

enum TodoStatus {
  TODO
  IN_PROGRESS
  SUBMITTED
  AWAITING_PAYOUT
  DONE
}

enum TodoPriority {
  LOW
  MEDIUM
  HIGH
}

enum ActivityType {
  LEAD_CREATED
  LEAD_UPDATED
  LEAD_DELETED
  PROJECT_CREATED
  PROJECT_UPDATED
  TASK_COMPLETED
  USER_JOINED
  INVOICE_PAID
  MAINTENANCE_DUE
  SYSTEM_ALERT
  FILE_UPLOAD
  MESSAGE
  MILESTONE
  PAYMENT
  STATUS_CHANGE
}

enum MaintenanceStatus {
  ACTIVE
  UPCOMING
  OVERDUE
  COMPLETED
  CANCELLED
}

enum LinkCategory {
  DESIGN
  DEVELOPMENT
  MARKETING
  TOOLS
  DOCUMENTATION
  OTHER
}

enum Visibility {
  INTERNAL
  PUBLIC
  CLIENT
}

enum AudienceType {
  USER
  TEAM
  ROLE
}

enum TrainingType {
  DOC
  VIDEO
  QUIZ
  LINK
}

enum CompletionStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETE
}

enum ServiceCategory {
  BUSINESS_WEBSITE
  NONPROFIT_WEBSITE
  PERSONAL_WEBSITE
  MAINTENANCE_PLAN
}

enum MaintenancePlanStatus {
  ACTIVE
  PAUSED
  CANCELLED
}

// ============================================
// NEW ENUMS FOR PLATFORM FEATURES
// ============================================

enum WebsiteQuality {
  POOR
  FAIR
  GOOD
  EXCELLENT
}

enum ProjectStage {
  DISCOVERY
  PROPOSAL
  DESIGN
  DEVELOPMENT
  REVIEW
  LAUNCH
  MAINTENANCE
}

enum TransactionType {
  DEPOSIT
  MILESTONE
  FINAL_PAYMENT
  MAINTENANCE_SUBSCRIPTION
  ADDON_SERVICE
  REFUND
}

enum TransactionStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
  CANCELLED
}

enum MaintenanceTier {
  BASIC // $150/mo, 2 hours
  STANDARD // $350/mo, 5 hours
  PREMIUM // $750/mo, 12 hours
}

// New nonprofit tiers aligned with business model
enum NonprofitTier {
  ESSENTIALS // $500/mo, 8 hours, max 3 subscriptions
  DIRECTOR // $750/mo, 16 hours, max 6 subscriptions
  COO // $2,000/mo, unlimited requests (fair-use), unlimited subscriptions
}

// Hour pack types for marketplace purchases
enum HourPackType {
  SMALL // 5 hours, $350, 60-day expiry
  MEDIUM // 10 hours, $650, 90-day expiry
  LARGE // 20 hours, $1,200, 120-day expiry
  PREMIUM // 10 hours, $850, never expires
}

// Change request categories
enum ChangeRequestCategory {
  CONTENT // Content updates
  BUG // Bug fixes
  FEATURE // New features
  DESIGN // Design tweaks
  SEO // SEO optimization
  SECURITY // Security updates
  OTHER // Other
}

// Change request priority
enum ChangeRequestPriority {
  LOW // 3-5 days
  NORMAL // 2-3 days
  HIGH // 1 day
  URGENT // Same day (+$50 fee)
  EMERGENCY // Immediate (bypasses limits)
}

// Usage warning levels
enum UsageWarningLevel {
  AT_80_PERCENT // 80% of hours used
  AT_2_HOURS // 2 hours remaining
  AT_LIMIT // 0 hours remaining
  FIRST_OVERAGE // First time going over
  ROLLOVER_EXPIRING // Rollover hours expiring soon
  PACK_EXPIRING // Hour pack expiring soon
}

enum SubscriptionStatus {
  ACTIVE
  PAUSED
  CANCELLED
  EXPIRED
}

enum EmailCategory {
  CLIENT_OUTREACH
  PROPOSAL
  INVOICE
  PROJECT_UPDATE
  MEETING_SCHEDULING
  FOLLOW_UP
  WELCOME
  MAINTENANCE
}

enum CampaignStatus {
  DRAFT
  SCHEDULED
  SENDING
  SENT
  PAUSED
}

enum EventStatus {
  PENDING
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  RESCHEDULED
}

enum ChatStatus {
  ACTIVE
  WAITING_FOR_HUMAN
  WITH_HUMAN
  RESOLVED
  ABANDONED
}

enum AIMessageRole {
  USER
  ASSISTANT
  SYSTEM
}

// ============================================
// NEW AUTH & SETTINGS MODELS
// ============================================

model UserProfile {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Business info (for clients)
  organizationName String?
  industry         String?
  organizationSize String?
  websiteUrl       String?
  taxId            String?
  businessAddress  String?

  // Professional info (for designers/admins)
  jobTitle           String?
  department         String?
  skills             String[] // Array of skill tags
  portfolioUrl       String?
  githubUrl          String?
  linkedinUrl        String?
  yearsExperience    Int?
  hourlyRate         Decimal? @db.Decimal(10, 2)
  availabilityStatus String?  @default("available")

  // Social links
  twitterUrl String?
  customLink String?

  // Privacy
  publicProfile Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("user_profiles")
}

model TwoFactorAuth {
  id          String    @id @default(cuid())
  userId      String    @unique
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  secret      String // Encrypted TOTP secret
  backupCodes String[] // Encrypted backup codes
  enabled     Boolean   @default(false)
  verifiedAt  DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@map("two_factor_auth")
}

model UserSession {
  id         String   @id @default(cuid())
  userId     String
  user       User     @relation("UserSessions", fields: [userId], references: [id], onDelete: Cascade)
  deviceInfo String?
  browser    String?
  os         String?
  ipAddress  String?
  location   String?
  lastActive DateTime @default(now())
  createdAt  DateTime @default(now())

  @@index([userId])
  @@map("user_sessions")
}

model NotificationPreferences {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Email notifications
  projectUpdatesEmail Boolean @default(true)
  billingEmail        Boolean @default(true)
  marketingEmail      Boolean @default(false)
  securityEmail       Boolean @default(true)

  // In-app notifications
  projectUpdatesApp Boolean @default(true)
  billingApp        Boolean @default(true)
  securityApp       Boolean @default(true)

  // Push notifications
  browserPushEnabled Boolean @default(false)

  // Schedule
  quietHoursStart String? // "22:00"
  quietHoursEnd   String? // "08:00"
  digestFrequency String? @default("none") // daily, weekly, none

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("notification_preferences")
}

model UserPreferences {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Appearance
  theme            String  @default("dark") // light, dark, auto
  accentColor      String? @default("#dc2626") // trinity-red
  fontSize         String  @default("medium") // small, medium, large
  reduceAnimations Boolean @default(false)

  // Language & Region
  language   String @default("en")
  dateFormat String @default("MM/DD/YYYY")
  timeFormat String @default("12h") // 12h, 24h

  // Dashboard
  defaultView      String  @default("kanban") // kanban, list, calendar
  sidebarCollapsed Boolean @default(false)
  compactMode      Boolean @default(false)

  // Communication
  preferredContact  String? // email, phone, sms
  responseTime      String?
  meetingPreference String? // in-person, video, phone
  bestTime          String? // morning, afternoon, evening

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("user_preferences")
}

model TosAcceptance {
  id         String   @id @default(cuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  version    String // e.g., "1.0"
  acceptedAt DateTime @default(now())
  ipAddress  String?
  userAgent  String?

  @@index([userId])
  @@map("tos_acceptances")
}

model LoginHistory {
  id         String   @id @default(cuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  success    Boolean  @default(true)
  ipAddress  String?
  location   String?
  deviceInfo String?
  browser    String?
  os         String?
  createdAt  DateTime @default(now())

  @@index([userId, createdAt])
  @@map("login_history")
}

// ============================================
// SEEZEE PLATFORM FEATURES - NEW MODELS
// ============================================

// Time tracking for tasks
model TimeLog {
  id          String    @id @default(cuid())
  todoId      String
  todo        Todo      @relation(fields: [todoId], references: [id], onDelete: Cascade)
  hoursSpent  Float
  description String?
  performedBy String? // User ID
  startedAt   DateTime?
  endedAt     DateTime?
  createdAt   DateTime  @default(now())

  @@index([todoId])
  @@map("time_logs")
}

// Maintenance activity logs
model MaintenanceLog {
  id          String          @id @default(cuid())
  planId      String
  plan        MaintenancePlan @relation(fields: [planId], references: [id], onDelete: Cascade)
  hoursSpent  Float
  description String
  performedBy String? // User ID of staff member
  performedAt DateTime        @default(now())
  billable    Boolean         @default(true)
  overage     Boolean         @default(false) // true if beyond included hours
  createdAt   DateTime        @default(now())

  @@index([planId])
  @@index([performedAt])
  @@map("maintenance_logs")
}

// Purchased hour packs for additional work
model HourPack {
  id              String          @id @default(cuid())
  planId          String
  plan            MaintenancePlan @relation(fields: [planId], references: [id], onDelete: Cascade)
  packType        HourPackType
  hours           Float // Total hours in pack
  hoursRemaining  Float // Hours still available
  cost            Int // Cost in cents
  purchasedAt     DateTime        @default(now())
  expiresAt       DateTime? // Null for never-expire packs
  neverExpires    Boolean         @default(false)
  stripePaymentId String?

  // Extension tracking
  timesExtended  Int       @default(0)
  originalExpiry DateTime? // Original expiry before extensions

  // Usage
  usedAt   DateTime? // When fully used
  isActive Boolean   @default(true)

  @@index([planId])
  @@index([expiresAt])
  @@index([isActive])
  @@map("hour_packs")
}

// Rollover hours tracking with FIFO expiration
model RolloverHours {
  id             String          @id @default(cuid())
  planId         String
  plan           MaintenancePlan @relation(fields: [planId], references: [id], onDelete: Cascade)
  hours          Float // Hours rolled over
  hoursRemaining Float // Hours still available
  sourceMonth    DateTime // Which month these came from
  expiresAt      DateTime // When these hours expire
  usedAt         DateTime? // When fully used
  isExpired      Boolean         @default(false)

  @@index([planId])
  @@index([expiresAt])
  @@map("rollover_hours")
}

// Track overage and warning notifications sent
model OverageNotification {
  id           String            @id @default(cuid())
  planId       String
  plan         MaintenancePlan   @relation(fields: [planId], references: [id], onDelete: Cascade)
  warningLevel UsageWarningLevel
  periodStart  DateTime // Which billing period this is for
  sentAt       DateTime          @default(now())
  emailTo      String // Email address sent to

  // For expiring hours/packs
  expiryDate    DateTime? // Date of expiring hours/pack
  hoursExpiring Float? // How many hours are expiring

  @@unique([planId, warningLevel, periodStart]) // Prevent duplicate warnings per period
  @@index([planId])
  @@map("overage_notifications")
}

// Finance transactions
model FinanceTransaction {
  id                   String            @id @default(cuid())
  projectId            String?
  project              Project?          @relation(fields: [projectId], references: [id])
  organizationId       String?
  organization         Organization?     @relation(fields: [organizationId], references: [id])
  type                 TransactionType
  amount               Int // in cents
  currency             String            @default("USD")
  status               TransactionStatus @default(PENDING)
  stripeInvoiceId      String?           @unique
  stripePaymentId      String?           @unique
  stripeSubscriptionId String?
  paymentMethod        String? // card, ach, manual
  description          String
  dueDate              DateTime?
  paidAt               DateTime?
  metadata             Json?
  notes                String?
  createdAt            DateTime          @default(now())
  updatedAt            DateTime          @updatedAt

  @@index([projectId])
  @@index([organizationId])
  @@index([status])
  @@map("finance_transactions")
}

// Maintenance subscriptions (separate from project-based MaintenancePlan)
model MaintenanceSubscription {
  id                   String             @id @default(cuid())
  organizationId       String
  organization         Organization       @relation(fields: [organizationId], references: [id])
  tier                 MaintenanceTier
  monthlyRate          Int // in cents
  hoursIncluded        Int // hours per month
  hoursUsed            Int                @default(0)
  status               SubscriptionStatus @default(ACTIVE)
  stripeSubscriptionId String?            @unique
  currentPeriodStart   DateTime
  currentPeriodEnd     DateTime
  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt
  cancelledAt          DateTime?

  @@index([organizationId])
  @@index([status])
  @@map("maintenance_subscriptions")
}

// Email templates
model EmailTemplate {
  id          String          @id @default(cuid())
  name        String          @unique
  category    EmailCategory
  subject     String
  htmlContent String          @db.Text
  textContent String?         @db.Text
  variables   String[] // e.g., ["clientName", "projectName", "amount"]
  active      Boolean         @default(true)
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  campaigns   EmailCampaign[]

  @@index([category])
  @@map("email_templates")
}

// Email campaigns for outreach
model EmailCampaign {
  id           String         @id @default(cuid())
  name         String
  templateId   String
  template     EmailTemplate  @relation(fields: [templateId], references: [id])
  targetStatus LeadStatus[]
  targetTags   String[]
  minLeadScore Int?
  status       CampaignStatus @default(DRAFT)
  scheduledFor DateTime?
  sentAt       DateTime?
  totalSent    Int            @default(0)
  opened       Int            @default(0)
  clicked      Int            @default(0)
  replied      Int            @default(0)
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt

  // Track which leads were targeted
  leads Lead[] @relation("LeadCampaigns")

  @@index([status])
  @@map("email_campaigns")
}

// Calendar events
model CalendarEvent {
  id             String        @id @default(cuid())
  title          String
  description    String?       @db.Text
  location       String?
  startTime      DateTime
  endTime        DateTime
  allDay         Boolean       @default(false)
  timezone       String        @default("America/New_York")
  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id])
  projectId      String?
  project        Project?      @relation(fields: [projectId], references: [id])
  createdBy      String // User ID
  attendees      String[] // User IDs or email addresses
  meetingUrl     String? // Zoom, Google Meet, etc.
  recurring      Boolean       @default(false)
  recurrenceRule String? // iCal RRULE format
  status         EventStatus   @default(SCHEDULED)
  remindersSent  Boolean       @default(false)
  color          String? // For calendar display
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  @@index([startTime])
  @@index([organizationId])
  @@index([projectId])
  @@map("calendar_events")
}

// AI Chatbot conversations (separate from team ChatMessage)
model AIConversation {
  id           String      @id @default(cuid())
  sessionId    String      @unique
  userId       String? // If logged in user
  visitorName  String?
  visitorEmail String?
  visitorPhone String?
  messages     AIMessage[]
  status       ChatStatus  @default(ACTIVE)
  handedOff    Boolean     @default(false)
  handedOffTo  String? // Admin user ID
  intent       String? // "pricing", "portfolio", "support", etc.
  leadQuality  String? // "hot", "warm", "cold"
  source       String? // URL where chat started
  device       String?
  browser      String?
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt
  closedAt     DateTime?

  @@index([status])
  @@index([createdAt])
  @@map("ai_conversations")
}

// AI chat messages
model AIMessage {
  id             String         @id @default(cuid())
  conversationId String
  conversation   AIConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  role           AIMessageRole
  content        String         @db.Text
  modelUsed      String?
  tokens         Int?
  confidence     Float?
  createdAt      DateTime       @default(now())

  @@index([conversationId])
  @@map("ai_messages")
}

// Session recordings for AI transcription
model Recording {
  id              String             @id @default(cuid())
  title           String
  filename        String
  filePath        String
  fileSize        Int
  mimeType        String
  duration        Int? // Duration in seconds
  status          RecordingStatus    @default(PENDING)
  category        RecordingCategory? // AI-tagged category based on content
  transcript      String?            @db.Text
  summary         String?            @db.Text
  actionItems     Json? // Array of action items extracted
  projectBrief    Json? // Auto-generated project brief
  isClientVisible Boolean            @default(false) // Whether client can view
  uploadedById    String
  uploadedBy      User               @relation("RecordingsUploaded", fields: [uploadedById], references: [id])
  projectId       String?
  project         Project?           @relation(fields: [projectId], references: [id])
  transcribedAt   DateTime?
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt

  @@index([status])
  @@index([category])
  @@index([uploadedById])
  @@index([projectId])
  @@map("recordings")
}

enum RecordingCategory {
  DISCOVERY_CALL // Initial client meeting
  DESIGN_REVIEW // Design feedback session
  TECHNICAL_DISCUSSION // Development/tech talk
  PROJECT_UPDATE // Progress update meeting
  BRAINSTORMING // Ideation session
  TRAINING // Client training/onboarding
  SUPPORT // Support/troubleshooting
  INTERNAL // Internal team meeting
  OTHER // Uncategorized
}

enum RecordingStatus {
  PENDING
  PROCESSING
  TRANSCRIBED
  ERROR
}
